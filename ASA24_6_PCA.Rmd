---
title: "PCA"
output: html_document
---

In this section, we are going to perform PCA (Principal Component Analysis) with the totals nutrients as is of the totals dataset, processed for clustering in the previous section.

Before proceeding, ensure to have four directories (folders) named as: 

- PCA_Nut_asis
- PCA_Nut_ave
- PCA_Cat_asis
- PCA_Cat_ave

PCA results will be saved in these folders. You can change those directory names, but if you do so, you will need to modify the directory name, “res_dir_xxx_xxxx”, to match your new directory name.

PCA can be done with the following four data types generated above: 

- Nutrients as is (`Nut_asis`), 
- Nutrients averaged across days (`Nut_ave`),
- Food categories as is (`Cat_asis`), and 
- Food categories averaged across days (`Cat_ave`). 

With `Nut_asis` and `Cat_asis`, each datapoint will be users on each day. Suited to track potential changes in users’ dietary habits over the course of the trial days.

With `Nut_ave` and `Cat_ave`, each datapoint will be users data averaged across days. Suited to analyze the average dietary pattern of users. 

Use `scale = TRUE` for the prcomp function to take care of variables measurements in different units. `scale = TRUE` transforms data by  $(x_{i} - mean(x)) / SD(x)$ so that all the variables will have zero mean and one standard deviation (and variance) and so they are comparable. 

<br>

Name the path to DietR directory where input files are pulled.
```{r}
  main_wd <- "~/GitHub/DietR"
```

Load the necessary functions
```{r}
  source("lib/specify_data_dir.R")
  source("lib/ggplot2themes.R")
  source("lib/PCA.R")
```

Set the default font size for plots.
```{r}
  ggplot2::theme_set(theme_bw(base_size = 14))
```

You can come back to the main directory by:
```{r, eval=FALSE}
  setwd(main_wd)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE)
knitr::opts_knit$set(root.dir = 'eg_data/VVKAJ')
```

Specify the directory where the data is.
```{r, eval = FALSE}
  SpecifyDataDirectory(directory.name= "eg_data/VVKAJ/")
```
<!-- [NOTE] SpecifyDataDirectory function is not executed by R markdown, but just showing  -->
<!--  the code so that this tutorial will have the same code as the R script.  -->

<br>

### Nutrient data as is, processed for clustering analyses

Load Nut_asis data.
```{r}
  Tot_m_QCed_Nut_asis <- read.table(file="VVKAJ_Tot_m_QCed_Nut_asis.txt", sep="\t", header=T)
```

Name your input data.
```{r}
  pca_input <- Tot_m_QCed_Nut_asis
```

Ensure your input file has the correct number of rows and columns.
```{r}
  dim(pca_input)
```

Perform PCA with the subset data, scaled.
```{r}
  scaled_pca <- prcomp(x=pca_input, scale = TRUE)   
```

Specify the directory (folder) to save the results.
```{r}
  res_dir_nut_asis = "PCA_Nut_asis" 
```

Specify the prefix of filenames to be saved. 
```{r}
  res_prefix_nut_asis = "VVKAJ_Nut_asis"
```

Save PCA output files in a specified folder (out.dir) and a prefix (out.prefix).
```{r}
  OutputPCA(pca.data=pca_input, pca.result=scaled_pca, 
             out.dir= res_dir_nut_asis, out.prefix= res_prefix_nut_asis )
```

This code will generate several output files all at once in the res_dir:

Output file postfix	       | File content
-------------------        | -----------------------------------
_biplotdots.pdf	PCA        | biplot with the datapoints as dots and with the variables shown as arrows
_biplotlabeled.pdf	       | PCA biplot with the datapoints labed with numbers and with the variables shown as arrows
_biplotlabeledwoarrows.pdf | 	The datapoints labed with numbers; variables are hidden
_directions.pdf	           | Variables shown as arrows only; the datapoints are hidden
_loadings_PC1.pdf	         | Loadings of PC1 shown as a bar chart.
_loadings_PC2.pdf	         | Loadings of PC2 shown as a bar chart.
_PC_loadings.txt	         | Text file with loadings of each PC for the variables.
_PC_var_explained.txt	     | Amount of variation explained by each PC
_PCs.txt	                 | The input file (totals/items) and the PCA results combined
_scree.pdf                 | PCA scree plot, showing the amount of variance explained by each PC.

<br>

Combine the input (totals before processing) with all the variables and the PC results.
```{r}
  SaveInputAndPCs(input="VVKAJ_Tot_m_QCed.txt", pca.results = scaled_pca, 
                  out.dir= res_dir_nut_asis, out.prefix= res_prefix_nut_asis)
```

**[Note]** Even though the input file has both nutrients (Nut) and food categories (Cat) data, PCA was done with only either Nut or Cat, not both.

<br>

---

PCA can be done in a similar way with the remaining `Nut_ave`, `Cat_asis`, and `Cat_ave` dataset. The R script has the codes to run PCA with those three datasets. But here they are omitted for brevity in this tutorial. 

Furthermore, the PCA script has each of the function to generate the outputs in case users would like to tweak the visualization conditions. The functions’ names are hopefully self-explanatory -- `LineScreePlot`, `BiplotDots`, `Biplotlabeled`, `BiplotLabeledwoArrows`, and `LoadingsPlot`.

<br>



---


Come back to the main directory before you start running another script.
```{r, eval=FALSE}
  setwd(main_wd)
```
  
