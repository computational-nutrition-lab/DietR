---
title: "Load and clean NHANES data"
output: html_document
---

NHANES is a national survey conducted with some thousands of participants across the US over two days. NHANES data is published every other year and consists of various kinds of data including dietary intake, body measurements, laboratory-taken data. Here, we will explore the dietary intake (food items) of participants and look at the relationship between dietary patterns and diabetic status in [NHANES 2015-2016](https://wwwn.cdc.gov/nchs/nhanes/continuousnhanes/default.aspx?BeginYear=2015).

Refer to [the NHANES data and documentation](https://wwwn.cdc.gov/nchs/nhanes/Default.aspx) for more information about each release (version) of NHANES and their variables measured.

Data are in .XPT format, and you will need a specific package, [SASxport](https://github.com/r-gregmisc/SASxport), to import it to R. The example data we will use here were downloaded from the NHANES 2015-2016 page and are in the “Raw_data” folder in the “NHANES” folder.

Open “02_load_clean_NHANES_food.R” script in the “users” folder and load the packages needed as per the directions.

<br>

---

Name the path to DietR directory where input files are pulled.
```{r}
  main_wd <- "~/GitHub/DietR"
```

Load the necessary functions.
```{r}
  source("lib/specify_data_dir.R")
  source("lib/load_clean_NHANES.R")
  source("lib/prep_data_for_clustering.R")
  source("lib/Food_tree_scripts/format.foods.r")
```

Install the SASxport package if it is not installed yet.
```{r, eval=FALSE}
  if (!require("SASxport", quietly = TRUE)) install.packages("SASxport")
```

You can come back to the main directory by:
```{r, eval=FALSE}
  setwd(main_wd)
```

---

### Load "food items" data and add food descriptions

#### Prepare the code table - replace special characters with "_" or "and".
Format the food table and save it as a .txt file.
```{r}
PrepareFoodCodeTable(raw.food.code.table = "eg_data/NHANES/Raw_data/FoodCodes_DRXFCD_I.XPT", 
                     out.fn =              "eg_data/NHANES/FoodCodes_DRXFCD_I_f.txt")  
```

Load the formatted foodcode table.
```{r}
foodcodetable_f <- read.table("eg_data/NHANES/FoodCodes_DRXFCD_I_f.txt", sep="\t", header=T)
```

Check the first 10 rows of the output.
```{r}
foodcodetable_f[1:10, ]
```

---

#### Load FPED15-16, needed for the AddFoodCat function. 
```{r}
FPED <- read.table("eg_data/NHANES/FPED/FPED_1516_forR.txt", sep="\t", header=T)
```

Check the first 2 rows of FPED.
```{r}
head(FPED, 2)
```

**Important!** Change the food code column name as Food_code.
```{r}
colnames(FPED)[1] <- "Food_code"
```

---

**[NOTE]** Raw food data (DR1IFF_I.XPT and DR2IFF_I.XPT) are very large files and cannot be accommodated by GitHub. Thus, you will want to download them separately, and save them in a directory of your choice. Replace the path to your directory that contains the raw food data in 
the following code that uses the `ImportNHANESFoodItems` function.
 
Different alphabets are used on the variables' names in different release of NHANES data.  Therefore, you will need to change the alphabet (and potentially the other parts of the variable names) in order to run this script with other releases of NHANES. For example, DR1IFDCD is a column name for the food code used in the NHANES 2015-2016, and the alphabet for this release is "I".
  
Import items data Day 1, add food item descriptions, and save it as a txt file.\
IT WILL LIKELY BE A HUGE FILE.

```{r}
download.file("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/DR1IFF_I.XPT", 
              destfile= "eg_data/NHANES/DR1IFF_I.XPT")
```



<!-- ```{r} -->
<!-- ImportNHANESFoodItems(data.name="E:/MSU OneDrive 20210829/UMinn/20_NHANES/2015-16/Data/DR1IFF_I.XPT",  -->
<!--                         food.code.column = "DR1IFDCD",  -->
<!--                         food.code.table = foodcodetable_f, -->
<!--                         out.fn = "eg_data/NHANES/DR1IFF_I_d.txt")  -->
<!--                         # 'd' stands for food descriptions -->
<!-- ``` -->


<!-- # Load the saved food items file. -->
<!--   Food_D1 <- read.table("eg_data/NHANES/DR1IFF_I_d.txt", sep="\t", header=T) -->

<!-- # Count the number of participants - should be 8505 people. -->
<!--   length(unique(Food_D1$SEQN))  -->

<!-- # Add the food category info and serving for each item. #### WILL TAKE A FEW MOMENTS. #### -->
<!--   AddFoodCat(input.food= Food_D1, -->
<!--              fped= FPED, -->
<!--              grams= "DR1IGRMS",  -->
<!--              out.fn= "eg_data/NHANES/Food_D1_FC.txt") -->
<!--   # It is OK to see a message saying "NAs introduced by coercion." -->
<!--   # NAs will be removed later in the filtering process. -->

<!-- # --------------------------------------------------------------------------------------------------------------- -->
<!-- # Import items data Day 2, add food item descriptions, and save it as a txt file. -->
<!--   ImportNHANESFoodItems(data.name="E:/MSU OneDrive 20210829/UMinn/20_NHANES/2015-16/Data/DR2IFF_I.XPT", -->
<!--                         food.code.column = "DR2IFDCD", -->
<!--                         food.code.table = foodcodetable_f, -->
<!--                         out.fn = "eg_data/NHANES/DR2IFF_I_d.txt") -->

<!-- # Add food item description and save it as a txt file. -->
<!--   Food_D2 <- read.table("eg_data/NHANES/DR2IFF_I_d.txt", sep="\t", header=T) -->

<!-- # Count the number of participants - should be 7027 people. -->
<!--   length(unique(Food_D2$SEQN))  -->

<!-- # Do the same for Day 2. Add the food items info and serving for each item.  -->
<!-- #### WILL TAKE A FEW MOMENTS. #### -->
<!--   AddFoodCat(input.food= Food_D2,  -->
<!--              fped= FPED,  -->
<!--              grams= "DR2IGRMS",  -->
<!--              out.fn= "eg_data/NHANES/Food_D2_FC.txt") -->
<!--   # It is OK to see a message saying "NAs introduced by coercion." -->
<!--   # NAs will be removed later in the filtering process. -->
