---
title: "Load and clean ASA24 data"
output: html_document
code_folding: hide
---

In this tutorial, we will use mock data from the VVKAJ dataset that was created with [ASA24](https://epi.grants.cancer.gov/asa24/). VVKAJ stands for Vegetarian, Vegan, Keto, American, Japanese and was designed because these different eating patterns reflect differences that are often seen in real data. This mock dataset contains dietary for 15 mock participants who report dietary data while following the 5 different dietary patterns (VVKAJ) for three days. There are a total of XX dietary records in this dataset.

ASA24 data includes the following files: _Items.csv, _INS.csv, _Responses.csv, _TNS.csv, Totals.csv, and TS.csv. Refer to the ASA24 Reserchers’ website for specific explanations for each file, but for the purpose of this tutorial, we focus on using the Items.csv, which has all the food items reported by the participants.

In this script, you will:\

1. Use Metadata 1 to filter out individuals;
2. Remove users that has only a small number of totals (days of record) - if you know which one to remove; and
3. Look for outliers in your totals by nutrient consumed on each day.

<br>

Name the path to DietR directory where input files are pulled.
```{r}
  main_wd <- "~/GitHub/DietR"
```

Load the necessary functions.
```{r}
  source("lib/specify_data_dir.R")
  source("lib/load_clean_ASA24.R")
  source("lib/format.file.R")
  source("lib/QCOutliers.R")
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE)
knitr::opts_knit$set(root.dir = 'eg_data/VVKAJ')
```

<br>

### Load ASA24 Items data

Specify the directory where the data is.
```{r, eval = FALSE}
  SpecifyDataDirectory(directory.name= "eg_data/VVKAJ/")
```
<!-- [NOTE] SpecifyDataDirectory function is not executed by R markdown, but just showing  -->
<!--  the code so that this tutorial will have the same code as the R script.  -->

Load your unprocessed (raw) food items-level data (as downloaded from the ASA24 study website).
The csv file will be loaded as a dataframe in R and be named as items_raw. 
```{r}
  items_raw <- read.csv("Raw_data/VVKAJ_Items.csv", sep = ",", header=T)
```

Show the first two lines of the items data.
```{r}
  head(items_raw, 2)
```

Save it as a .txt file.

This will be saved in GitHub/DietR/eg_data/VVKAJ directory.
```{r}
  write.table(items_raw, "VVKAJ_Items.txt", sep="\t", row.names=F)
```

Special characters common in food names in dietary data such as `'`, `,`, `%` may interfere correct data loading in R; thus, we replace them with an underscore `_`.

This function can only take .txt files as input. Specify column(s) to be processed in the "columns" argument and the output file name in the outfn argument; "_f" stands for "formatted".
```{r}
format.file(filename = "VVKAJ_Items.txt",
            columns  = "Food_Description",
            outfn    = "VVKAJ_Items_f.txt")
```

[Note] It is best practice to avoid overwriting your raw data. Always save formated/manipulated versions as a new file as described above.

Load the Items_f.txt file to take a look at it.
```{r}
items_f <- read.table("VVKAJ_Items_f.txt", sep="\t", header=T)
```

All special characters in the items data should have been replaced with an underscore in the Food_Description column, the last column of the items_f. We can confirm that by using the head function, which shows the first six rows of the specified dataset by default.
```{r, eval=FALSE}
  head(items_f)
```

<details>
  <summary>Click to expand output</summary>
```{r, echo=FALSE, eval=TRUE}
head(items_f)
```
</details>

The last column of items_f_id should have food descriptions with special characters replaced with “_”.

Add a human-readable sample identifier (SampleID) with a desired prefix, and save it as a txt file. SampleIDs are IDs unique to each combination of users and day and represent days of dietary intake in this dataset.  
```{r}
  AddSampleIDtoItems(input.fn="VVKAJ_Items_f.txt", user.name="UserName", recall.no="RecallNo",
                     prefix="vvkaj.", out.fn="VVKAJ_Items_f_id.txt")
```

Load the formatted Items file with SampleID added.
```{r}
  items_f_id <- read.table("VVKAJ_Items_f_id.txt", sep="\t", header=T)
```

A combination of the specified prefix and sequential number should be added in the SampleID column, the first column of the items_f_id dataframe.  You will probably need to scroll up the output in the console a little bit to view the first column.     
```{r, eval=FALSE}
  head(items_f_id)
```

<details>
  <summary>Click to expand output</summary>
```{r, echo=FALSE, eval=TRUE}
head(items_f_id)
```
</details>

<br>

Ensure your items file has the expected dimensions (number of rows x number of columns,
shown as number of obs. and number of variables) in the environment window of R Studio. Or by using dim(items_f_id) and dim(items_raw). Note that `items_f_id` has 1 more column (131 variables) than items_raw because a new column of SampleID has been added to it.
```{r}
dim(items_f_id)
```

<br>

### <Optional> Use individuals_to_remove.txt to filter out users marked as Remove = yes.
Load your metadata that has information about which UserName(s) to remove.
```{r}
ind_to_rm <- read.table("individuals_to_remove.txt", sep="\t", header=T)
```

Take a look. Metadata for this purpose (`ind_to_rm`) has `UserName` and which one to be removed:
```{r}
ind_to_rm
```

Show which has "yes" in the "Remove" column.
```{r}
subset(ind_to_rm, Remove == "yes")

```

As shown, the user named “VVKAJ116” is marked to be removed. VVKAJ116 has only 1 day of data, which may not be complete, thus it is marked as an individual to remove.  However, be careful when deleting a datapoint from your study and never remove individuals from the raw dataset to ensure you can always go back and include them if desired.


Remove the specified individuals.\
The output will be saved as a text file with the specified name. This assumes the usernames are in `UserName` column, and will print which user(s) will be removed.
```{r}
  RemoveRows(data=items_f_id, metadata.file= ind_to_rm,
             output.name= "VVKAJ_Items_f_id_s.txt")
```

Load the output for further processing.
```{r}
  items_f_id_s <- read.table("VVKAJ_Items_f_id_s.txt", header=T, sep="\t")
```

Show unique usernames in `items_f_id_s` and confirm `VVKAJ116` has been removed.
```{r}
  unique(items_f_id_s$UserName)
```

[Note] The numbers in the square brackets of the output indicate the sequential number of each element to help count the number of elements. 

<br>

### <Optional> Merge individuals' metadata to items.   

`ind_metadata` has the participants' gender, age, height, weight, BMI, and Waist.Circumference, etc. If desired, this individual-specific information can be added to items data.
  
Load ind_metadata.txt.
```{r}
ind_metadata <- read.table("ind_metadata.txt", sep="\t", header=T)
```

Look at what the metadata has.
```{r}
head(ind_metadata)
```
  
Add this metadata of each participant in totals or items. 'NA' will be inserted to UserNames which are not in ind_metadata.
```{r}
items_f_id_s_m <- merge(x=items_f_id_s, y=ind_metadata, by="UserName", all.x=T)
```
  
Check that the items data and metadata are merged.
```{r, eval=FALSE}
head(items_f_id_s_m)
```

<details>
  <summary>Click to expand output</summary>
```{r, echo=FALSE, eval=TRUE}
head(items_f_id_s_m)
```
</details>

<br>

Save the merged dataframe as a .txt file.
```{r}
  write.table(items_f_id_s_m, "VVKAJ_Items_f_id_s_m.txt", sep="\t", row.names=F, quote=F)
```

<br>

Furthermore, as a quick wway to look at the metadata of only the selected individuals, you can subset the metadata to just the usernames present in the analysis dataset (items_f_id_s) using the "%in%" operator.
```{r}
ind_metadata_s <- ind_metadata[ind_metadata$UserName %in% items_f_id_s$UserName, ] 
```

Use the tail function to show the last six rows of `ind_metadata_s`. You can see the last individual in this metadata is now VVKAJ115, and that VVKAJ116, which was not in `items_f_id_s`, has been omitted.
```{r}
tail(ind_metadata_s)
```

<br>

### Generate new totals file if any edits were made to the items file. 

Use one of the input files saved above as an input for calculating totals for. Specify which columns have usernames and Recall.No., which is the number of recorded days. 
```{r}
  GenerateTotals(inputfn = "VVKAJ_Items_f_id_s_m.txt", 
                 User.Name = 'UserName', 
                 Recall.No = 'RecallNo',
                 outfn = "VVKAJ_Tot.txt")
```

Load the total file generated above.
```{r}
  new_totals <- read.table("VVKAJ_Tot.txt", header=T, sep="\t")
```

The number of rows should be {No. of users x No. days}. For the example data, 15 users x 3 days = 45 rows (observations).
```{r}
  nrow(new_totals) 
```

View the new_totals.
```{r, eval=FALSE}
  head(new_totals)
```

<details>
  <summary>Click to expand output</summary>
```{r, echo=FALSE, eval=TRUE}
head(new_totals)
```
</details>

<br>

### <Optional> Add the participants' metadata back to totals.

Load ind_metadata.txt if you have not done so.
```{r}
  ind_metadata <- read.table("ind_metadata.txt", sep="\t", header=T)
```

Add this metadata of each participant to totals. 'NA' will be inserted to UserNames which are not in `ind_metadata`. 
```{r}
  new_totals_m <- merge(x=new_totals, y=ind_metadata, by="UserName", all.x=T)
```
  
Check that the items data and metadata are merged.
```{r, eval=FALSE}
  head(new_totals_m)
```

<details>
  <summary>Click to expand output</summary>
```{r, echo=FALSE, eval=TRUE}
head(new_totals_m)
```
</details>

<br>

Save the merged dataframe as a .txt file.
```{r}
  write.table(new_totals_m, "VVKAJ_Tot_m.txt", sep="\t", row.names=F, quote=F)
```

<br>

### Quality Control (QC) for totals data

Totals data may contain outliers due to errors in dietary reporting. These errors may be due to omission or inaccurate over- or under-estimation of portion size, leading to improbable nutrient totals. ASA24 provides General Guidelines for Reviewing & Cleaning Data for identifying and removing suspicious records. 

Here, we will identify records that contain values that fall outside typically observed ranges of kilocalories (KCAL), protein (PROT), total fat (TFAT), and vitamin C (VC). The ASA24 guide provides ranges of beta carotene (BCAR), too, however, outlier checking for BCAR is omitted in this tutorial but can be considered if you identify it as a nutrient that has a high variance in your study dataset.

Please note that your input dataframe (QCtotals) will be overwritten after each outlier removal.

  
Load your totals if necessary - to be used as input for QC.
```{r}
  new_totals <- read.table("VVKAJ_Tot_m.txt", sep="\t", header=T)
```
    
Define your totals dataset to be used as input.
```{r}
  QCtotals <- new_totals  
```

Flag if KCAL is <600 or >5700 --> ask remove or not --> if yes, remove those rows
```{r}
  QCOutliers(input.data = QCtotals, target.colname = "KCAL", min = 600, max = 5700)
```

This function will print out rows that fall outside the specified min-max range, and **a dialogue  box** will appear outside the R Studio, asking whether to remove them. You should make sure to review these records carefully to double check if the removal is warranted. It is possible to have a valid record that could meet the threshold for removal. Only you will know if you can trust the record when working with real data.


Flag if PROT is <10 or >240 --> ask remove or not --> if yes, remove those rows
```{r}
  QCOutliers(input.data = QCtotals, target.colname = "PROT", min = 10, max = 240)
```

Flag if TFAT is <15 or >230 --> ask remove or not --> if yes, remove those rows
```{r}
  QCOutliers(input.data = QCtotals, target.colname = "TFAT", min = 15, max = 230)
```

Flag if VC (Vitamin C) is <5 or >400 --> ask remove or not --> if yes, remove those rows
```{r}
  QCOutliers(input.data = QCtotals, target.colname = "VC", min = 5, max = 400)
```

You may find numerous potential outliers here. Then, click "No", and view those outliers with their other nutrient intake information by running the following;
```{r}
  VC_outliers <- subset(new_totals, VC < 5 | VC > 400)    
```

Sort in the order of VC and show only the specified variables.
```{r}
  VC_outliers[order(VC_outliers$BCAR, decreasing = T),
              c('UserName', 'KCAL', 'VC', 'V_TOTAL', 'V_DRKGR', 'F_TOTAL')]  # F is fruits.
```

Save as "Totals_m_QCed.txt"
```{r}
  write.table(QCtotals, "VVKAJ_Tot_m_QCed.txt", sep="\t", quote=F, row.names=F)
```

<br>

---
  
Come back to the main directory before you start running another script.
```{r, eval=FALSE}
  setwd(main_wd)
```
  
