---
title: "*k*-means"
output: html_document
---

In this section, we are going to perform *k*-means analysis with the totals nutrients as is of the totals dataset, processed for clustering in the previous section.

Before proceeding, ensure to have four directories (folders) named as: 

- kmeans_Nut_asis
- kmeans_Nut_ave
- kmeans_Cat_asis
- kmeans_Cat_ave

*k*-means analysis results will be saved in this folder.  You can change those directory names, but if you do so, you will need to modify the directory name, `res_dir_xxx_xxxx`, to match your new directory name.

<br>

Name the path to DietR directory where input files are pulled.
```{r}
  main_wd <- "~/GitHub/DietR"
```

Load the necessary functions
```{r}
  source("lib/specify_data_dir.R")
  source("lib/k-means.R")
```

You can come back to the main directory by:
```{r, eval=FALSE}
  setwd(main_wd)
```

<br>

### Import data from your data directory

Specify the directory where the data is.
```{r, eval = FALSE}
  SpecifyDataDirectory(directory.name= "eg_data/VVKAJ/")
```
<!-- [NOTE] SpecifyDataDirectory function is not executed by R markdown, but just showing  -->
<!--  the code so that this tutorial will have the same code as the R script.  -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE)
knitr::opts_knit$set(root.dir = 'eg_data/VVKAJ')
```

Here, we will run *k*-means analysis for each of Nutrient as is, Nutrient average, Food categories as is, and Food categories average.

<br>  

---

### Nutrient data as is, processed for clustering analyses

Load Nut_asis data.
```{r}
  Tot_m_QCed_Nut_asis <- read.table(file="VVKAJ_Tot_m_QCed_Nut_asis.txt", sep="\t", header=T)
```

Scale your input file and name it as *k*-means_input.
```{r}
  kmeans_input <- scale(Tot_m_QCed_Nut_asis)
```

Ensure your input file has the correct number of rows and columns.
```{r}
  dim(kmeans_input)
```

Specify the directory (folder) to save the results.
```{r}
  res_dir_nut_asis = "kmeans_Nut_asis"
```

Specify the prefix of filenames to be saved.
```{r}
  res_prefix_nut_asis = "VVKAJ_Nut_asis"
```

Run the elbow, silhouette, and gap methods to find an optimum K (number of clusters). Do not alter the name of the input file: kmeans_input. This function below assumes that the input is named as `kmeans_input`. 

You can only run those three methods for K = 1 through (number of observations - 1). The gap method output will be printed on the Console. The gap values are plotted in xxx_gapmethod.pdf.
```{r}
  ChooseK(out.dir= res_dir_nut_asis, out.prefix= res_prefix_nut_asis)
```

This code will generate three output files all at once in the res_dir_xxx_xxxx:

Output file postfix |	File content
------------------- | ---------------------------------------------------------------
_elbowmethod.pdf	  |	Shows total withinâˆ’clusters sum of squares for each K.
_gapmethod.pdf	    |	Shows the Gap statistic (k) for each K, and if the factoextra package is used, the optimal K is marked by a dotted line.
_silhouettemethod.pdf	 |	Shows the Average silhouette width (~ goodness of fit) for each K, and if the factoextra package is used, the optimal K is marked by a dotted line.

<br>

Look at the three figures generated by the ChooseK function above. The elbow and gap methods did not give a distinct peak, but the silhouette method gave a peak at K=3. K=2,4,5 also has relatively high silhouette width (~goodness of fit).

Gap method output (.pdf)
```{r, out.width=400}
  knitr::include_graphics("VVKAJ_Nut_asis_elbowmethod.pdf", error = FALSE)
```
<!-- error = FALSE argument is based on this post https://stackoverflow.com/questions/60292022/knitr-cannot-find-img-files-in-static-folder -->

![Image Title](VVKAJ_Nut_asis_elbowmethod.pdf){width=65%}

  
With specific K values in mind, perform *k*-means analysis with one specified K. This will save Dim1 x Dim2 plot as a .pdf file in your `out.dir`. Change the filename as necessary.
```{r}
  OneK(myK= 3, out.dir= res_dir_nut_asis, out.fn = "VKAJ_Nut_asis_K3")
```

```{r}
  oneKplot
```


Or try multiple Ks and print the biplots in one panel. Likewise, This will save a Dim1 x Dim2 plot for each of the chosen K as a .pdf file in your `out.dir`. Change the filename to be saved as a PDF as necessary. This function uses the factoextra and gridExtra packages.
```{r}
  MultipleK(myKs = c(3,4,5,6), out.dir = res_dir_nut_asis, out.fn = "VKAJ_Nut_asis_K3-6")
```

<br>

---

*k*-means analysis can be performed in a similar way with the remaining `Nut_ave`, `Cat_asis`, and `Cat_ave` dataset.  The R script has the codes to run *k*-means with those three datasets. But here they are omitted for brevity in this tutorial. 

More detailed information about the gap and silhouette method can be found at: [K-means cluster analysis](https://afit-r.github.io/kmeans_clustering#silo), and [determining the best number of clusters](http://www.sthda.com/english/articles/29-cluster-validation-essentials/96-determiningthe-optimal-number-of-clusters-3-must-know-methods/).


<br>

---

Come back to the main directory before you start running another script.
```{r, eval=FALSE}
  setwd(main_wd)
```
  
