# ===============================================================================================================
# Look at the PCA results in detail.
# Version 1
# Created on 12/02/2022 by Rie Sadohara
# ===============================================================================================================

# Not needed. Rather include PCA color coded by GLU_index in the PCA script, 
# because autoplot function is needed to generate a biplot with the same axis scales with those 
# generated by SavePCAResults() function.
# If autoplot is not used, the axis values will be as is and will be confusing to the users.
# Autoplot is not able to draw ellipses, but cannot do anything about it.


# ===============================================================================================================
# Header 1 -- explain the purpose of this section.
# ===============================================================================================================
# Here, we will color-code the datapoints in PCA biplots by a desired variable in the metadata to 
# facilitate understanding of clustering of individuals. 

# Set working directory to "dietary_patterns".
  Session --> Set working direHctory --> Choose directory.   
  setwd("~/GitHub/DietR")

# Name your main directory for future use. 
  main_wd <- file.path(getwd())

# Load necessary functions.
  source("lib/specify_data_dir.R")
  source("lib/ggplot2themes.R")

# Call color palette.
  distinct100colors <- readRDS("lib/distinct100colors.rda")

# You can come back to the main directory by:
  setwd(main_wd) 

# ===============================================================================================================
# Nutrients results 
# ===============================================================================================================
  
# Specify the directory where the data is.
  SpecifyDataDirectory("eg_data/NHANES/Laboratory_data")

# ---------------------------------------------------------------------------------------------------------------
# Create a biplot with Normal, Prediabetes, and Diabetes people color-coded.   

# Load the input & PC info.
  Nut_PCs <- read.table("males60to79_Nut_PCA/males60to79_Nut_PCs.txt", sep="\t", header=T)
  head(Nut_PCs)
  scaled_pca[rotation]

# Load the % variance explained.
  Nut_var_exp <- read.table("males60to79_Nut_PCA/males60to79_Nut_PC_var_explained.txt", sep="\t", header=T)

# Change GLU_index to a factor so that factors will be displayed in order.
  Nut_PCs$GLU_index <- factor(Nut_PCs$GLU_index, levels= c("Normal", "Prediabetic", "Diabetic"))

# ---------------------------------------------------------------------------------------------------------------
# Generate a PC1 x PC2 plot with the users colored by their diets.
  PC12_GLU <- ggplot(Nut_PCs, aes(x=PC1, y=PC2, color=GLU_index, fill=GLU_index)) + 
    geom_point(size=3, ) +
    no_grid + space_axes +
    scale_fill_manual( values = distinct100colors) +
    scale_color_manual(values = distinct100colors) +
    scale_x_continuous(expand = expansion(mult=c(0.1, 0.1))) + # give some space on the lower and the upper limits of X.
    scale_y_continuous(expand = expansion(mult=c(0.1, 0.1))) + # give some space on the lower and the upper limits of Y.
    labs(x = paste("PC1 (", round(Nut_var_exp[1,2]*100, 1), "%)", sep=""),  
         y = paste("PC2 (", round(Nut_var_exp[2,2]*100, 1), "%)", sep="")) +
    stat_ellipse(data=Nut_PCs, aes(color=GLU_index), level=0.95) +
    theme(aspect.ratio = 1)
  PC12_GLU
  
  